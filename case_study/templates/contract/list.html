<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
</head>
<body>
<div class="row ">
    <div class="col-md-12 d-flex justify-content-center ">
        <h1>List Contract</h1>
    </div>
</div>

<div class="row">
    <div th:replace=" layout :: navbar"></div>
</div>

<!--<div class="container">-->
<!--    <div class="row">-->
<!--        <div class="col-md-4">-->
<!--            <form action="/contract/list">-->
<!--                <div>-->
<!--                    <input-->
<!--                            type="text"-->
<!--                            class="form-control"-->
<!--                            aria-describedby="button-addon2"-->
<!--                            name="keyword"-->
<!--                    />-->
<!--                    <button class="btn btn-outline-primary" type="submit" id="button-addon2"-->
<!--                            data-mdb-ripple-color="dark">-->
<!--                        Search-->
<!--                    </button>-->
<!--                </div>-->
<!--            </form>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<div class="container">
    <table id="tableCustomer" class="table table-striped table-bordered" style="width: 100%">
        <thead>
        <tr class="table-dark">
            <th scope="col">#</th>
            <th scope="col">Service</th>
            <th scope="col">Customer</th>
            <th scope="col">Start Date</th>
            <th scope="col">End Date</th>
            <th scope="col">Deposit</th>
            <th scope="col">Total money</th>
            <th scope="col">Attached Service</th>
        </tr>
        </thead>
        <tbody id="list" class="table-light">
<!--        <tr th:each="contract,loop:${contractList}">-->
<!--            <td th:text="${loop.count}"></td>-->
<!--            <td th:text="${contract.facility.name}"></td>-->
<!--            <td th:text="${contract.customer.name}"></td>-->
<!--            <td th:text="${contract.startDate}"></td>-->
<!--            <td th:text="${contract.endDate}"></td>-->
<!--            <td th:text="${contract.deposit}"></td>-->
<!--            <td></td>-->
<!--            <td>-->
<!--                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal1">-->
<!--                    +-->
<!--                </button>-->
<!--                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal2">-->
<!--                    Attached Service List-->
<!--                </button>-->
<!--            </td>-->
<!--        </tr>-->
        </tbody>
    </table>
</form>
</div>

<nav aria-label="Page navigation example">
    <ul class="pagination">
        <li class="page-item">
            <a class="page-link"
               id="previousBtn"
               aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        <li class="btn btn-light">
            <span id="pageNumber"></span>
            /
            <span id="totalPage"></span>
        </li>
        <li class="page-item">
            <a class="page-link"
               id="nextBtn"
               aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
    </ul>
</nav>

<!--<div class="row">-->
<!--    <div class="col-md-12 d-flex justify-content-center ">-->
<!--        <a th:href="@{/contract/list(page=${contractList.number - 1}-->
<!--    ,keyword=${keyword})}"-->
<!--           th:if="${contractList.hasPrevious()}">-->
<!--            <button style="color: lightskyblue">Pervious</button>-->
<!--        </a>-->
<!--        <span th:text="${contractList.number+1}"></span>-->
<!--        /-->
<!--        <span th:text="${contractList.totalPages}"></span>-->
<!--        <a th:href="@{/contract/list(page=${contractList.number + 1},-->
<!--    keyword=${keyword})}"-->
<!--           th:if="${contractList.hasNext()}">-->
<!--            <button>Next</button>-->
<!--        </a>-->
<!--    </div>-->
<!--</div>-->


<div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel1">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="container d-flex  justify-content-md-center">
                        <div class="row">
                            <div class="col-md-12 ">
                                <div class="row">

                                    <div class="col-md-6 mb-3 form-check">
                                        <label class="form-label">Check in</label>
                                        <input type="date" class="form-control" name="">
                                    </div>

                                    <div class="col-md-6 mb-3 form-check">
                                        <label class="form-label">Check out</label>
                                        <input type="date" class="form-control" name="">
                                    </div>

                                    <div class="col-md-6 mb-3 form-check">
                                        <label class="form-label">Deposit</label>
                                        <input type="number" class="form-control" name="">
                                    </div>

                                    <div class="col-md-6 mb-3 form-check">
                                        <label class="form-label">Total Price</label>
                                        <input type="number" class="form-control" name="">
                                    </div>

                                    <div class="col-md-6 mb-3 form-check">
                                        <label class="form-label">Service Customers</label>
                                        <select>
                                            <option selected>Service Customers</option>
                                            <option value="1">Diamond</option>
                                            <option value="2">Platinium</option>
                                            <option value="3">Gold</option>
                                            <option value="4">Silver</option>
                                            <option value="5">Member</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6 mb-3 form-check">
                                        <label class="form-label">Service </label>
                                        <select>
                                            <option selected>Service</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3 form-check">
                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                                data-bs-target="#exampleModal3">
                                            Create Accompanied Service
                                        </button>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Submit</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"></button>
                <button type="button" class="btn btn-primary"></button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel2" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel2">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Unit</th>
                        <th>Cost</th>
                        <th>Quantity</th>
                    </tr>
                    </thead>
                    <tbody id="attachFacility">
                    </tbody>
                </table>
            </div>

            <div class="modal-footer">

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                <button type="button" class="btn btn-primary">Delete</button>

            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="exampleModal3" tabindex="-1" aria-labelledby="exampleModalLabel3" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel3">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="container d-flex  justify-content-md-center">
                        <div class="row">
                            <div class="col-md-12 ">
                                <div class="row">

                                    <div class="col-md-6 mb-3 form-check">
                                        <label class="form-label">ID </label>
                                        <input type="number" class="form-control" name="">
                                    </div>

                                    <div class="col-md-6 mb-3 form-check">
                                        <label class="form-label">Contract Id</label>
                                        <input type="number" class="form-control" name="">
                                    </div>

                                    <div class="col-md-6 mb-3 form-check">
                                        <label class="form-label">Attach Facility Id</label>
                                        <input type="number" class="form-control" name="">
                                    </div>

                                    <div class="col-md-6 mb-3 form-check">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" class="form-control" name="">
                                    </div>

                                    <button type="submit" class="btn btn-primary">Submit</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Create Contract Detail</button>
            </div>
        </div>
    </div>
</div>
</body>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery-3.6.0.min.js"></script>
<script>
    let curPage = 0;
    let lastPage = -1;
    getContractList(curPage);
    $("#previousBtn").click(function () {
        if (curPage == 0) {
            getContractList(0);
        } else getContractList(--curPage);
    });
    $("#nextBtn").click(function () {
        if (lastPage === curPage) {
            getContractList(lastPage);
        } else
            getContractList(++curPage);
    });
    
    function getContractList(pageNumber) {
        $.ajax({
            type:"Get",
            url: "http://localhost:8080/contractRest?page=" + pageNumber,
            success:function (contractPage){
                lastPage=contractPage.totalPages -1;
                let contractList=contractPage.content;
                let htmlStr="";
                for (let i = 0; i <contractList.length ; i++) {
                    htmlStr +=`
                    <tr>
                    <td>${i+1}</td>
                    <td>${contractList[i].facility.name}</td>
                    <td>${contractList[i].customer.name}</td>
                    <td>${contractList[i].startDate}</td>
                    <td>${contractList[i].endDate}</td>
                    <td>${contractList[i].deposit}</td>`
                    if (contractList[i].contractDetails.length==0){
                        htmlStr+=`
                        <td>${contractList[i].facility.cost}</td>`
                    }else {
                        let cost=contractList[i].facility.cost;
                        for (let j = 0; j <contractList[i].contractDetails.length ; j++) {
                            cost+=contractList[i].contractDetails[j].quantity * contractList[i].contractDetails[j].attachFacility.cost;
                        }
                        htmlStr+=`<td>`+cost+`</td>>`
                    }
                    htmlStr += `<td>
                        <button type="button"
                                class="btn btn-outline-secondary"
                                data-bs-toggle="modal"
                                data-bs-target="#addService">
                           +
                        </button>
                        </td>
                        <td>
                        <button type="button"
                                class="btn btn-outline-secondary"
                                data-bs-toggle="modal"
                                data-bs-target="#exampleModal2"
                                onclick="viewAttachFacility(` + contractList[i].id + `)">
                            Attached Service List
                        </button>
                    </td>`;
                    htmlStr += `</tr>`;
                }
                $('#list').html(htmlStr);
                $("#pageNumber").text(pageNumber + 1);
                $("#totalPage").text(contractPage.totalPages);
            },
            error: function (errorResult) {
                }
        });
    }

    function viewAttachFacility(contractId) {
        $.ajax({
            type: "GET",
            url: "http://localhost:8080/contractRest/detail?id=" + contractId,
            success: function (contractObj) {
                let htmlStr = "";
                if (contractObj.contractDetails.length == 0) {
                    htmlStr = `<tr>
                        <td colspan="4">No Attach Facility</td>
                    </tr>`;
                } else {
                    for (let i = 0; i < contractObj.contractDetails.length; i++) {
                        htmlStr += `
                    <tr>
                        <td>${contractObj.contractDetails[i].attachFacility.name}</td>
                        <td>${contractObj.contractDetails[i].attachFacility.cost}</td>
                        <td>${contractObj.contractDetails[i].attachFacility.unit}</td>
                        <td>${contractObj.contractDetails[i].attachFacility.status}</td>
                    </tr>
                `;
                    }
                }
                $('#attachFacility').html(htmlStr);
            },
            error: function (errorResult) {
                console.log(errorResult);
            }
        });
    }

</script>
</html>